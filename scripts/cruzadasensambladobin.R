# PRUEBAS DE ENSAMBLADO


# **************************************
# IMPORTANTE: AQUÍ HAY QUE DECIDIR ANTES LOS PARÁMETROS A UTILIZAR
# EN CADA ALGORITMO, NO VALE GRID
# Importante, la dependiente en letras Yes, No
# Preparación de archivo, variables y CV. 
# Esto se cambia para cada archivo.
# Necesario haber cambiado la var dep a Yes,No.
# **************************************

# LEER LAS CRUZADAS DE ENSAMBLADO, SON LIGERAMENTE DIFERENTES
# A LAS UTILIZADAS ANTERIORMENTE AUNQUE SE LLAMAN IGUAL

rm(list=ls())

library(MASS)  #stepAIC, 
library(dfexplore) #dfplot
library(caret)  #traincontrol
library(readxl)  #read_excel
library(dfexplore) #dfplot
library(questionr)
library(psych)
library(ggplot2)
library(corrplot)
library(car)
library(caret)
library(Amelia)
library(dplyr) #glimpse
library(rpart) 
library(rpart.plot)
library(randomForest)


source("FuncionesParaDataUnderstandingAndPreparation.R")
source("cruzadas ensamblado binaria fuente.R")

# Data Preparation-----

datafile<-readRDS("datapiece1")
#validacion tipos de datos
str(datafile)
glimpse(datafile)  #se usar str, dado que da idea de cuantos levels se tienen

summary(datafile)

# Retipado 
##se va a revisar los datos para validar que esta correctamente categorizados
datafile$MachineIdentifier <-toString(datafile$MachineIdentifier) #es del tipo string, no entrara en el analisis
datafile$EngineVersion <- toString(datafile$EngineVersion)
datafile$AppVersion <- toString(datafile$AppVersion)
datafile$AvSigVersion <- toString(datafile$AvSigVersion)
datafile$IsBeta <- factor(datafile$IsBeta)
datafile$RtpStateBitfield <- factor(datafile$RtpStateBitfield)
datafile$IsSxsPassiveMode <- factor(datafile$IsSxsPassiveMode)
datafile$AVProductsInstalled <- factor(datafile$AVProductsInstalled)
datafile$AVProductsEnabled <- factor(datafile$AVProductsEnabled)
datafile$HasTpm <- factor(datafile$HasTpm)
datafile$OsVer <- toString(datafile$OsVer)
datafile$OsBuildLab <- toString(datafile$OsBuildLab)
datafile$IsProtected <- factor(datafile$IsProtected)
datafile$AutoSampleOptIn <- factor(datafile$AutoSampleOptIn)
datafile$SMode <- factor(datafile$SMode)
datafile$SmartScreen <- toString(datafile$SmartScreen)
datafile$Firewall <- factor(datafile$Firewall)
datafile$UacLuaenable <-factor(datafile$UacLuaenable)
datafile$Census_MDC2FormFactor <- toString(datafile$Census_MDC2FormFactor)
datafile$Census_HasOpticalDiskDrive <- factor(datafile$Census_HasOpticalDiskDrive)
datafile$Census_ChassisTypeName <- toString(datafile$Census_ChassisTypeName)
datafile$Census_PowerPlatformRoleName <- toString(datafile$Census_PowerPlatformRoleName)
datafile$Census_InternalBatteryType <- toString(datafile$Census_InternalBatteryType)
datafile$Census_OSVersion <- toString(datafile$Census_OSVersion)
datafile$Census_OSArchitecture <- factor(datafile$Census_OSArchitecture)
datafile$Census_OSBranch <- toString(datafile$Census_OSBranch)
datafile$Census_OSEdition <- toString(datafile$Census_OSEdition)
datafile$Census_OSSkuName <- toString(datafile$Census_OSSkuName)
datafile$Census_IsPortableOperatingSystem <- factor(datafile$Census_IsPortableOperatingSystem)
datafile$Census_GenuineStateName <- factor(datafile$Census_GenuineStateName)
datafile$Census_IsFlightingInternal <- factor(datafile$Census_IsFlightingInternal)
datafile$Census_IsFlightsDisabled <- factor(datafile$Census_IsFlightsDisabled)
datafile$Census_ThresholdOptIn <- factor(datafile$Census_ThresholdOptIn)
datafile$Census_IsSecureBootEnabled <- factor(datafile$Census_IsSecureBootEnabled)
datafile$Census_IsWIMBootEnabled <- factor(datafile$Census_IsWIMBootEnabled)
datafile$Census_IsVirtualDevice <- factor(datafile$Census_IsVirtualDevice)
datafile$Census_IsTouchEnabled <- factor(datafile$Census_IsTouchEnabled)
datafile$Census_IsPenCapable <- factor(datafile$Census_IsPenCapable)
datafile$Census_IsAlwaysOnAlwaysConnectedCapable <- factor(datafile$Census_IsAlwaysOnAlwaysConnectedCapable)
datafile$Wdft_IsGamer <- factor(datafile$Wdft_IsGamer)
datafile$HasDetections <- factor(datafile$HasDetections)


# DeclaracionVariables 
dput(names(datafile))
listclass <- c("ProductName","IsBeta", "RtpStateBitfield", "IsSxsPassiveMode","AVProductsInstalled", 
               "AVProductsEnabled", "HasTpm","Platform", "Processor", "OsPlatformSubRelease",
               "SkuEdition", "IsProtected", "AutoSampleOptIn","PuaMode","SMode", "Firewall", "UacLuaenable", 
               "Census_DeviceFamily","Census_ProcessorClass", "Census_PrimaryDiskTypeName", 
               "Census_HasOpticalDiskDrive","Census_OSArchitecture", "Census_OSInstallTypeName",
               "Census_OSWUAutoUpdateOptionsName","Census_IsPortableOperatingSystem", 
               "Census_GenuineStateName","Census_ActivationChannel", "Census_IsFlightingInternal", 
               "Census_IsFlightsDisabled","Census_FlightRing", "Census_ThresholdOptIn", "Census_IsSecureBootEnabled", 
               "Census_IsWIMBootEnabled", "Census_IsVirtualDevice", "Census_IsTouchEnabled", 
               "Census_IsPenCapable", "Census_IsAlwaysOnAlwaysConnectedCapable", "Wdft_IsGamer")

listconti <- c("AVProductStatesIdentifier","CountryIdentifier", "CityIdentifier", "OrganizationIdentifier",
               "GeoNameIdentifier", "LocaleEnglishNameIdentifier", "OsBuild", "OsSuite","IeVerIdentifier",
               "Census_OEMNameIdentifier", "Census_OEMModelIdentifier", "Census_ProcessorCoreCount",
               "Census_ProcessorManufacturerIdentifier", "Census_ProcessorModelIdentifier",
               "Census_PrimaryDiskTotalCapacity","Census_SystemVolumeTotalCapacity","Census_TotalPhysicalRAM", 
               "Census_InternalPrimaryDiagonalDisplaySizeInInches", "Census_InternalPrimaryDisplayResolutionHorizontal",
               "Census_InternalPrimaryDisplayResolutionVertical", "Census_InternalBatteryNumberOfCharges",  
               "Census_OSBuildNumber","Census_OSBuildRevision",  "Census_OSInstallLanguageIdentifier", 
               "Census_OSUILocaleIdentifier","Census_FirmwareManufacturerIdentifier", "Census_FirmwareVersionIdentifier",
               "Wdft_RegionIdentifier")
varChar <- c("MachineIdentifier", "EngineVersion", "AppVersion", 
             "AvSigVersion","OsVer","OsBuildLab","SmartScreen", "Census_MDC2FormFactor",  
             "Census_ChassisTypeName",  
             "Census_PowerPlatformRoleName", "Census_InternalBatteryType", 
             "Census_OSVersion", 
             "Census_OSBranch", "Census_OSEdition", "Census_OSSkuName")
vardep<- c("HasDetections")


# AnalisisDatos-Missings 

matriznulos<-matrizdenulos(datafile)

nrows <- nrow(datafile)
ncomplete <- sum(complete.cases(datafile))
result <- ncomplete/nrows  
result #porcentaje de filas completas, se observa que elos el 0.0025 esta completo por lo que se tendra que analizar cada valor nulo.

#graficas para apoyar visualizacion de datos nulos
# - Análisis de la coexistencia de datos faltantes en varias variables
corrplot(cor(is.na(datafile[colnames(datafile)[colSums(
  is.na(datafile))>0]])),method = "ellipse",type = "upper")

dfplot(datafile)  #grafica para ver data y q nulos
missmap(datafile, main = "Missing values vs observed")
#antes de realizar correcciones sobre los missings como eliminar o imputar, se va a analizar otros tipos de errores, para hacer una correcta imputacion


# DataPreparation-TratamientosNulos
#de lo analizado en los valores nulos, se va a eliminar las filas que tengan campos missings menores o iguales a 5, estos representan la minoria

matriznulos[order(matriznulos[,2]),]

datafile<-datafile[!is.na(datafile$RtpStateBitfield), ]
datafile<-datafile[!is.na(datafile$AVProductStatesIdentifier), ]
datafile<-datafile[!is.na(datafile$AVProductsInstalled), ]
datafile<-datafile[!is.na(datafile$AVProductsEnabled), ]
datafile<-datafile[!is.na(datafile$IsProtected), ]
datafile<-datafile[!is.na(datafile$UacLuaenable), ]
datafile<-datafile[!is.na(datafile$Census_InternalPrimaryDiagonalDisplaySizeInInches), ]
datafile<-datafile[!is.na(datafile$Census_InternalPrimaryDisplayResolutionHorizontal), ]
datafile<-datafile[!is.na(datafile$Census_InternalPrimaryDisplayResolutionVertical), ]
datafile<-datafile[!is.na(datafile$Census_ProcessorCoreCount), ]
datafile<-datafile[!is.na(datafile$Census_ProcessorManufacturerIdentifier), ]
datafile<-datafile[!is.na(datafile$Census_ProcessorModelIdentifier), ]
datafile<-datafile[!is.na(datafile$Census_IsVirtualDevice), ]
datafile<-datafile[!is.na(datafile$Firewall), ]
datafile<-datafile[!is.na(datafile$Census_PrimaryDiskTotalCapacity), ]
datafile<-datafile[!is.na(datafile$Census_SystemVolumeTotalCapacity), ]
datafile<-datafile[!is.na(datafile$Census_OSInstallLanguageIdentifier), ]
datafile<-datafile[!is.na(datafile$Census_IsAlwaysOnAlwaysConnectedCapable), ]

#tambien se va a eliminar columans con % nulos mayor a 50%

cols.dont.want <- c("DefaultBrowsersIdentifier", "Census_IsFlightingInternal", 
                    "Census_ThresholdOptIn","Census_IsWIMBootEnabled") # if you want to remove multiple columns
datafile <- datafile[, ! names(datafile) %in% cols.dont.want, drop = F]

matriznulos<-matrizdenulos(datafile)

#se encuentra que Census_TotalPhysicalRAM solo tiene 4 nulos se eliminara
datafile<-datafile[!is.na(datafile$Census_TotalPhysicalRAM), ]

matriznulos<-matrizdenulos(datafile)


# DataPreparation-Imputacion de la data
#renombrado de variables declaradas por borrado de datos
listclass <- c("ProductName","IsBeta", "RtpStateBitfield", "IsSxsPassiveMode","AVProductsInstalled", 
               "AVProductsEnabled", "HasTpm","Platform", "Processor", "OsPlatformSubRelease",
               "SkuEdition", "IsProtected", "AutoSampleOptIn","PuaMode","SMode", "Firewall", "UacLuaenable", 
               "Census_DeviceFamily","Census_ProcessorClass", "Census_PrimaryDiskTypeName", 
               "Census_HasOpticalDiskDrive","Census_OSArchitecture", "Census_OSInstallTypeName",
               "Census_OSWUAutoUpdateOptionsName","Census_IsPortableOperatingSystem", 
               "Census_GenuineStateName","Census_ActivationChannel", 
               "Census_IsFlightsDisabled","Census_FlightRing", "Census_IsSecureBootEnabled", 
               "Census_IsVirtualDevice", "Census_IsTouchEnabled", 
               "Census_IsPenCapable", "Census_IsAlwaysOnAlwaysConnectedCapable", "Wdft_IsGamer")

listconti <- c("AVProductStatesIdentifier","CountryIdentifier", "CityIdentifier", "OrganizationIdentifier",
               "GeoNameIdentifier", "LocaleEnglishNameIdentifier", "OsBuild", "OsSuite","IeVerIdentifier",
               "Census_OEMNameIdentifier", "Census_OEMModelIdentifier", "Census_ProcessorCoreCount",
               "Census_ProcessorManufacturerIdentifier", "Census_ProcessorModelIdentifier",
               "Census_PrimaryDiskTotalCapacity","Census_SystemVolumeTotalCapacity","Census_TotalPhysicalRAM", 
               "Census_InternalPrimaryDiagonalDisplaySizeInInches", "Census_InternalPrimaryDisplayResolutionHorizontal",
               "Census_InternalPrimaryDisplayResolutionVertical", "Census_InternalBatteryNumberOfCharges",  
               "Census_OSBuildNumber","Census_OSBuildRevision",  "Census_OSInstallLanguageIdentifier", 
               "Census_OSUILocaleIdentifier","Census_FirmwareManufacturerIdentifier", "Census_FirmwareVersionIdentifier",
               "Wdft_RegionIdentifier")
varChar <- c("MachineIdentifier", "EngineVersion", "AppVersion", 
             "AvSigVersion","OsVer","OsBuildLab","SmartScreen", "Census_MDC2FormFactor",  
             "Census_ChassisTypeName",  
             "Census_PowerPlatformRoleName", "Census_InternalBatteryType", 
             "Census_OSVersion", 
             "Census_OSBranch", "Census_OSEdition", "Census_OSSkuName")
vardep<- c("HasDetections")

# DataPreparation - Categorias mal representadas y minoritarias Parte I
#validacion de errores en clases
## get mode of all vars
var_mode <- sapply(datafile, mode)
## produce error if complex or raw is found
if (any(var_mode %in% c("complex", "raw"))) stop("complex or raw not allowed!")
## get class of all vars
var_class <- sapply(datafile, class)

## produce error if an "AsIs" object has "logical" or "character" mode
if (any(var_mode[var_class == "AsIs"] %in% c("logical", "character"))) {
  stop("matrix variables with 'AsIs' class must be 'numeric'")
}

## index of factor columns
fctr <- which(sapply(datafile, is.factor))
## factor variables that have skipped explicit conversion in step 2
# drop unused levels
datafile[fctr] <- lapply(datafile[fctr], droplevels)

## export factor levels actually used by `lm` and `glm`
lev <- lapply(datafile[fctr], levels)
## count number of levels
nl <- lengths(lev)

for (vari in listclass)
{cat(vari,sep="\n")
  print(table(datafile[,vari],exclude=NULL))
}

#revisar categorias poco representadas, IsBeta, AutoSampleOptIn, PuaMode, SMode, Census_DeviceFamily,
# Census_IsFlightsDisabled, Census_IsPortableOperatingSystem
#categorias con muchos nulos Census_ProcessorClass,
#eliminar categorias con poca representacion y con muchos nulos
#categoria para arreglar Census_PrimaryDiskTypeName,

cols.dont.want <- c("IsBeta", "AutoSampleOptIn", "PuaMode", "SMode", "Census_DeviceFamily",
                    "Census_IsFlightsDisabled", "Census_IsPortableOperatingSystem", "Census_ProcessorClass") # if you want to remove multiple columns
datafile <- datafile[, ! names(datafile) %in% cols.dont.want, drop = F]

datafile$Census_PrimaryDiskTypeName<-replace(datafile$Census_PrimaryDiskTypeName, 
                                             which(datafile$Census_PrimaryDiskTypeName
                                                   %in% c("", "UNKNOWN", "Unspecified")), NA)

listclass <- c("ProductName", "RtpStateBitfield", "IsSxsPassiveMode","AVProductsInstalled", 
               "AVProductsEnabled", "HasTpm","Platform", "Processor", "OsPlatformSubRelease",
               "SkuEdition", "IsProtected",  "Firewall", "UacLuaenable", 
               "Census_PrimaryDiskTypeName", 
               "Census_HasOpticalDiskDrive","Census_OSArchitecture", "Census_OSInstallTypeName",
               "Census_OSWUAutoUpdateOptionsName", 
               "Census_GenuineStateName","Census_ActivationChannel", 
               "Census_FlightRing", "Census_IsSecureBootEnabled", 
               "Census_IsVirtualDevice", "Census_IsTouchEnabled", 
               "Census_IsPenCapable", "Census_IsAlwaysOnAlwaysConnectedCapable", "Wdft_IsGamer")

## index of factor columns
fctr <- which(sapply(datafile, is.factor))
# drop unused levels
datafile[fctr] <- lapply(datafile[fctr], droplevels)

#validar nuevamente factores, algunos con pocas categorias y mal representadas, podrian dar error
for (vari in listclass)
{cat(vari,sep="\n")
  print(table(datafile[,vari],exclude=NULL))
}

#se revisa que ProductName, UacLuaenable pueden eliminarse
cols.dont.want <- c("ProductName", "UacLuaenable") # if you want to remove multiple columns
datafile <- datafile[, ! names(datafile) %in% cols.dont.want, drop = F]

listclass <- c("RtpStateBitfield", "IsSxsPassiveMode","AVProductsInstalled", 
               "AVProductsEnabled", "HasTpm","Platform", "Processor", "OsPlatformSubRelease",
               "SkuEdition", "IsProtected",  "Firewall", 
               "Census_PrimaryDiskTypeName", 
               "Census_HasOpticalDiskDrive","Census_OSArchitecture", "Census_OSInstallTypeName",
               "Census_OSWUAutoUpdateOptionsName", 
               "Census_GenuineStateName","Census_ActivationChannel", 
               "Census_FlightRing", "Census_IsSecureBootEnabled", 
               "Census_IsVirtualDevice", "Census_IsTouchEnabled", 
               "Census_IsPenCapable", "Census_IsAlwaysOnAlwaysConnectedCapable", "Wdft_IsGamer")


for (vari in listclass)
{cat(vari,sep="\n")
  print(table(datafile[,vari],exclude=NULL))
}

datafile3<-datafile

#se empieza la imputacion con las continuas
#se saca una copia de la variable objetivo
vectvardep <- datafile$HasDetections
input<-datafile[,-69]

indcont <- which(sapply(input, is.integer))
input[indcont] <- sapply(input[, indcont], as.numeric)

input[,as.vector(which(sapply(input, class)=="numeric"))]<-sapply(
  Filter(is.numeric, input),function(x) ImputacionCuant(x,"media"))

matriznulos <- matrizdenulos(input)

# C?digo para imputar varias categ?ricas. Si solo se quiere imputar una, variable<-ImputacionCuali(variable,"moda")

## index of factor columns
fctr <- which(sapply(input, is.factor))
# imputacion cualitativas
input[fctr] <- sapply(
  Filter(is.factor, input),function(x) ImputacionCuali(x,"moda"))
#se cambia el tipo de factor a character al imputar, as? que hay que indicarle que es factor
input[,fctr] <- lapply(input[,fctr], factor)

matriznulos <- matrizdenulos(input)

#datafile<-na.omit(datafile)

#Estandarizacion
means <-apply(input[,listconti],2,mean,na.rm=TRUE)
sds<-sapply(input[,listconti],sd,na.rm=TRUE)
datafile2<-scale(input[,listconti], center = means, scale = sds)
input<-data.frame(cbind(datafile2,input[,c(listclass)]))
input <- data.frame(cbind(input, vectvardep))
colnames(input)[colnames(input)=="vectvardep"]<-vardep

matriznulos <- matrizdenulos(input)

datafile<-input

# Generacion de dummies
#Se valida de nuevo categorias mal representadas para eliminarlas luego de dummies
for (vari in listclass)
{cat(vari,sep="\n")
  print(table(input[,vari],exclude=NULL))
}
#la categorias candidatas son las siguientes:
#RtpStateBitfield.3 , RtpStateBitfield.5, RtpStateBitfield.8
#AVProductsInstalled.4, AVProductsEnabled.0, AVProductsEnabled.0
#Platform.windows7
#Processor.arm64
#OsPlatformSubRelease.windows7
#SkuEdition.Invalid
#Census_OSArchitecture.arm64
#Census_OSInstallTypeName.CleanPCRefresh
#Census_GenuineStateName.UNKNOWN
#Census_FlightRing.Disabled,Census_FlightRing.RP

library(dummies)
datadummies<- dummy.data.frame(datafile, listclass, sep = ".")

datadummies$RtpStateBitfield.3<-NULL
datadummies$RtpStateBitfield.5 <-NULL
datadummies$RtpStateBitfield.8 <- NULL
datadummies$AVProductsInstalled.5 <- NULL
datadummies$AVProductsEnabled.0 <- NULL
datadummies$AVProductsEnabled.4 <- NULL
datadummies$Platform.windows7 <- NULL
datadummies$Processor.arm64 <- NULL
datadummies$OsPlatformSubRelease.windows7 <- NULL
datadummies$SkuEdition.Invalid <- NULL
datadummies$Census_OSArchitecture.arm64 <- NULL
datadummies$Census_OSInstallTypeName.CleanPCRefresh <- NULL
datadummies$Census_GenuineStateName.UNKNOWN <- NULL
datadummies$Census_FlightRing.RP <- NULL

dput(names(datadummies))
datafilebck<-datafile

#se prepara archivo solo con las variables a trabajar

# APLICACIÓN CRUZADAS PARA ENSAMBLAR-----

#dput(names(saheartbis))
set.seed(12345)

datafile<-datadummies
archivo<-datafile

listconti<-c("AVProductsInstalled.1", "Census_OSArchitecture.amd64",
             "Census_IsTouchEnabled.0","Census_OSWUAutoUpdateOptionsName.Notify",
             "RtpStateBitfield.0",
             "Census_IsVirtualDevice.0", "Wdft_IsGamer.0",
             "AVProductStatesIdentifier", "Census_OSInstallTypeName.Update",
             "Census_FlightRing.Retail","Census_OEMNameIdentifier",
             "Census_InternalBatteryNumberOfCharges", "Firewall.0",
             "Census_PrimaryDiskTotalCapacity")

listclass<-c("")
grupos<-4
sinicio<-1234
repe<-5

medias1<-cruzadalogistica(data=datafile,
                          vardep="HasDetections",listconti=c("AVProductsInstalled.1", "Census_OSArchitecture.amd64",
                                                             "Census_IsTouchEnabled.0","Census_OSWUAutoUpdateOptionsName.Notify",
                                                             "RtpStateBitfield.0",
                                                             "Census_IsVirtualDevice.0", "Wdft_IsGamer.0",
                                                             "AVProductStatesIdentifier", "Census_OSInstallTypeName.Update",
                                                             "Census_FlightRing.Retail","Census_OEMNameIdentifier",
                                                             "Census_InternalBatteryNumberOfCharges", "Firewall.0",
                                                             "Census_PrimaryDiskTotalCapacity"),
                          listclass=c(""),grupos=4,sinicio=1234,repe=5)

medias1bis<-as.data.frame(medias1[1])
medias1bis$modelo<-"Logistica"
predi1<-as.data.frame(medias1[2])
predi1$logi<-predi1$Yes

medias2<-cruzadaavnnetbin(data=datafile,
                          vardep="HasDetections",listconti=c("AVProductsInstalled.1", "Census_OSArchitecture.amd64",
                                                             "Census_IsTouchEnabled.0","Census_OSWUAutoUpdateOptionsName.Notify",
                                                             "RtpStateBitfield.0",
                                                             "Census_IsVirtualDevice.0", "Wdft_IsGamer.0",
                                                             "AVProductStatesIdentifier", "Census_OSInstallTypeName.Update",
                                                             "Census_FlightRing.Retail","Census_OEMNameIdentifier",
                                                             "Census_InternalBatteryNumberOfCharges", "Firewall.0",
                                                             "Census_PrimaryDiskTotalCapacity"),
                          listclass=c(""),grupos=5,sinicio=1234,repe=5,
                          size=c(5),decay=c(0.1),repeticiones=5,itera=200)

medias2bis<-as.data.frame(medias2[1])
medias2bis$modelo<-"avnnet"
predi2<-as.data.frame(medias2[2])
predi2$avnnet<-predi2$Yes


medias3<-cruzadarfbin(data=datafile,
                      vardep="HasDetections",listconti=listconti,
                      listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                      mtry=3,ntree=100,nodesize=10,replace=TRUE)


medias3bis<-as.data.frame(medias3[1])
medias3bis$modelo<-"rf"
predi3<-as.data.frame(medias3[2])
predi3$rf<-predi3$Yes

medias4<-cruzadagbmbin(data=datafile,
                       vardep=vardep,listconti=listconti,
                       listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                       n.minobsinnode=5,shrinkage=0.03,n.trees=1000,interaction.depth=2)


medias4bis<-as.data.frame(medias4[1])
medias4bis$modelo<-"gbm"
predi4<-as.data.frame(medias4[2])
predi4$gbm<-predi4$Yes

medias5<-cruzadaxgbmbin(data=archivo,
                        vardep=vardep,listconti=listconti,
                        listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                        min_child_weight=10,eta=0.08,nrounds=100,max_depth=6,
                        gamma=0,colsample_bytree=1,subsample=1,
                        alpha=0,lambda=0,lambda_bias=0)


medias5bis<-as.data.frame(medias5[1])
medias5bis$modelo<-"xgbm"
predi5<-as.data.frame(medias5[2])
predi5$xgbm<-predi5$Yes


medias6<-cruzadaSVMbin(data=datafile,
                       vardep=vardep,listconti=listconti,
                       listclass=listclass,grupos=grupos,
                       sinicio=sinicio,repe=repe,C=0.01)

medias6bis<-as.data.frame(medias6[1])
medias6bis$modelo<-"svmLinear"
predi6<-as.data.frame(medias6[2])
predi6$svmLinear<-predi6$Yes


medias7<-cruzadaSVMbinPoly(data=datafile,
                           vardep=vardep,listconti=listconti,
                           listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                           C=0.01,degree=2,scale=0.1)

medias7bis<-as.data.frame(medias7[1])
medias7bis$modelo<-"svmPoly"
predi7<-as.data.frame(medias7[2])
predi7$svmPoly<-predi7$Yes

medias8<-cruzadaSVMbinRBF(data=datafile,
                          vardep=vardep,listconti=listconti,
                          listclass=listclass,grupos=grupos,
                          sinicio=sinicio,repe=repe,
                          C=2,sigma=0.01)

medias8bis<-as.data.frame(medias8[1])
medias8bis$modelo<-"svmRadial"
predi8<-as.data.frame(medias8[2])
predi8$svmRadial<-predi8$Yes

union1<-rbind(medias1bis,medias2bis,
              medias3bis,medias4bis,medias6bis,
              medias7bis,medias8bis)

#par(cex.axis=0.5)
boxplot(data=union1,tasa~modelo,main="TASA FALLOS", cex=2)
boxplot(data=union1,auc~modelo,main="AUC", cex=1)



# CONSTRUCCIÓN DE TODOS LOS ENSAMBLADOS
# SE UTILIZARÁN LOS ARCHIVOS SURGIDOS DE LAS FUNCIONES LLAMADOS predi1,...

unipredi<-cbind(predi1,predi2,predi3,predi4,predi6,predi7,predi8)

# Esto es para eliminar columnas duplicadas
unipredi<- unipredi[, !duplicated(colnames(unipredi))]

# Construccion de ensamblados, cambiar al gusto

unipredi$predi9<-(unipredi$logi+unipredi$avnnet)/2
unipredi$predi10<-(unipredi$logi+unipredi$rf)/2
unipredi$predi11<-(unipredi$logi+unipredi$gbm)/2
#unipredi$predi12<-(unipredi$logi+unipredi$xgbm)/2
unipredi$predi13<-(unipredi$logi+unipredi$svmLinear)/2
unipredi$predi14<-(unipredi$logi+unipredi$svmPoly)/2
unipredi$predi15<-(unipredi$logi+unipredi$svmRadial)/2
unipredi$predi16<-(unipredi$avnnet+unipredi$rf)/2
unipredi$predi17<-(unipredi$avnnet+unipredi$gbm)/2
#unipredi$predi18<-(unipredi$avnnet+unipredi$xgbm)/2
unipredi$predi19<-(unipredi$avnnet+unipredi$svmLinear)/2
unipredi$predi20<-(unipredi$avnnet+unipredi$svmPoly)/2
unipredi$predi21<-(unipredi$avnnet+unipredi$svmRadial)/2
unipredi$predi22<-(unipredi$rf+unipredi$gbm)/2
#unipredi$predi23<-(unipredi$rf+unipredi$xgbm)/2
unipredi$predi24<-(unipredi$rf+unipredi$svmLinear)/2
unipredi$predi25<-(unipredi$rf+unipredi$svmPoly)/2
unipredi$predi26<-(unipredi$rf+unipredi$svmRadial)/2
#unipredi$predi27<-(unipredi$gbm+unipredi$xgbm)/2
unipredi$predi28<-(unipredi$gbm+unipredi$svmLinear)/2
unipredi$predi29<-(unipredi$gbm+unipredi$svmPoly)/2
unipredi$predi30<-(unipredi$gbm+unipredi$svmRadial)/2

unipredi$predi31<-(unipredi$logi+unipredi$avnnet+unipredi$rf)/3
unipredi$predi32<-(unipredi$logi+unipredi$avnnet+unipredi$gbm)/3
#unipredi$predi33<-(unipredi$logi+unipredi$avnnet+unipredi$xgbm)/3
unipredi$predi34<-(unipredi$logi+unipredi$avnnet+unipredi$svmLinear)/3
unipredi$predi35<-(unipredi$logi+unipredi$avnnet+unipredi$svmPoly)/3
unipredi$predi36<-(unipredi$logi+unipredi$avnnet+unipredi$svmRadial)/3
unipredi$predi37<-(unipredi$logi+unipredi$rf+unipredi$gbm)/3
#unipredi$predi38<-(unipredi$logi+unipredi$rf+unipredi$xgbm)/3
unipredi$predi39<-(unipredi$logi+unipredi$rf+unipredi$svmLinear)/3
unipredi$predi40<-(unipredi$logi+unipredi$rf+unipredi$svmPoly)/3
unipredi$predi41<-(unipredi$logi+unipredi$rf+unipredi$svmRadial)/3
#unipredi$predi42<-(unipredi$logi+unipredi$gbm+unipredi$xgbm)/3
#unipredi$predi43<-(unipredi$logi+unipredi$gbm+unipredi$xgbm)/3
unipredi$predi44<-(unipredi$logi+unipredi$gbm+unipredi$svmLinear)/3
unipredi$predi45<-(unipredi$logi+unipredi$gbm+unipredi$svmPoly)/3
unipredi$predi46<-(unipredi$logi+unipredi$gbm+unipredi$svmRadial)/3
#unipredi$predi47<-(unipredi$logi+unipredi$xgbm+unipredi$svmLinear)/3
#unipredi$predi48<-(unipredi$logi+unipredi$xgbm+unipredi$svmPoly)/3
#unipredi$predi49<-(unipredi$logi+unipredi$xgbm+unipredi$svmRadial)/3

unipredi$predi50<-(unipredi$rf+unipredi$gbm+unipredi$svmLinear)/3
unipredi$predi51<-(unipredi$rf+unipredi$gbm+unipredi$svmPoly)/3
unipredi$predi52<-(unipredi$rf+unipredi$gbm+unipredi$svmRadial)/3

#unipredi$predi53<-(unipredi$rf+unipredi$xgbm+unipredi$svmLinear)/3
#unipredi$predi54<-(unipredi$rf+unipredi$xgbm+unipredi$svmPoly)/3
#unipredi$predi55<-(unipredi$rf+unipredi$xgbm+unipredi$svmRadial)/3

unipredi$predi56<-(unipredi$rf+unipredi$avnnet+unipredi$gbm)/3
#unipredi$predi57<-(unipredi$rf+unipredi$avnnet+unipredi$xgbm)/3
unipredi$predi58<-(unipredi$rf+unipredi$avnnet+unipredi$svmLinear)/3
unipredi$predi59<-(unipredi$rf+unipredi$avnnet+unipredi$svmPoly)/3
unipredi$predi60<-(unipredi$rf+unipredi$avnnet+unipredi$svmRadial)/3

unipredi$predi61<-(unipredi$avnnet+unipredi$gbm+unipredi$svmLinear)/3
unipredi$predi62<-(unipredi$avnnet+unipredi$gbm+unipredi$svmPoly)/3
unipredi$predi63<-(unipredi$avnnet+unipredi$gbm+unipredi$svmRadial)/3

unipredi$predi64<-(unipredi$logi+unipredi$rf+unipredi$gbm+unipredi$avnnet)/4
#unipredi$predi65<-(unipredi$logi+unipredi$rf+unipredi$xgbm+unipredi$avnnet)/4
#unipredi$predi66<-(unipredi$logi+unipredi$rf+unipredi$xgbm+unipredi$avnnet)/4

#unipredi$predi67<-(unipredi$logi+unipredi$rf+unipredi$xgbm+unipredi$avnnet+unipredi$svmLinear)/5
#unipredi$predi68<-(unipredi$logi+unipredi$rf+unipredi$xgbm+unipredi$avnnet+unipredi$svmPoly)/5
#unipredi$predi69<-(unipredi$logi+unipredi$rf+unipredi$xgbm+unipredi$avnnet+unipredi$svmRadial)/5




# Listado de modelos a considerar, cambiar al gusto

dput(names(unipredi))

# listado<-c("logi", "avnnet", 
#            "rf","gbm",  "svmLinear",  "svmPoly", 
#            "svmRadial","predi9", "predi10", "predi11", "predi12", 
#            "predi13", "predi14", "predi15", "predi16", "predi17", "predi18", 
#            "predi19", "predi20", "predi21", "predi22", "predi23", "predi24", 
#            "predi25", "predi26", "predi27", "predi28", "predi29", "predi30", 
#            "predi31", "predi32", "predi33", "predi34", "predi35", "predi36", 
#            "predi37", "predi38", "predi39", "predi40", "predi41", "predi42", 
#            "predi43", "predi44", "predi45", "predi46", "predi47", "predi48", 
#            "predi49", "predi50", "predi51", "predi52", "predi53", "predi54", 
#            "predi55", "predi56", "predi57", "predi58", "predi59", "predi60", 
#            "predi61", "predi62", "predi63", "predi64", "predi65", "predi66", 
#            "predi67", "predi68", "predi69")

listado<-c( "logi", "avnnet", "rf",  
             "gbm", "svmLinear", "svmPoly", 
             "svmRadial", "predi9", "predi10", "predi11", "predi13", "predi14", 
             "predi15", "predi16", "predi17", "predi19", "predi20", "predi21", 
             "predi22", "predi24", "predi25", "predi26", "predi28", "predi29", 
             "predi30", "predi31", "predi32", "predi34", "predi35", "predi36", 
             "predi37", "predi39", "predi40", "predi41", "predi44", "predi45", 
             "predi46", "predi50", "predi51", "predi52", "predi56", "predi58", 
             "predi59", "predi60", "predi61", "predi62", "predi63", "predi64"
)

# Cambio a Yes, No, todas las predicciones

for (prediccion in listado)
{
  unipredi[,prediccion]<-ifelse(unipredi[,prediccion]>0.5,"Yes","No")
}

# Defino funcion tasafallos

tasafallos<-function(x,y) {
  confu<-confusionMatrix(x,y)
  tasa<-confu[[3]][1]
  return(tasa)
}

auc<-function(x,y) {
  curvaroc<-roc(response=x,predictor=y)
  auc<-curvaroc$auc
  return(auc)
}

# Se obtiene el numero de repeticiones CV y se calculan las medias por repe en
# el data frame medias0

repeticiones<-nlevels(factor(unipredi$Rep))
unipredi$Rep<-as.factor(unipredi$Rep)
unipredi$Rep<-as.numeric(unipredi$Rep)


# Se obtiene el numero de repeticiones CV y se calculan las medias por repe en # el data frame medias0

repeticiones<-nlevels(factor(unipredi$Rep)) 
unipredi$Rep<-as.factor(unipredi$Rep) 
unipredi$Rep<-as.numeric(unipredi$Rep)
medias0<-data.frame(c()) 
for (prediccion in listado) 
{ 
  for (repe in 1:repeticiones) 
  { 
    paso <- unipredi[(unipredi$Rep==repe),] 
    pre<-factor(paso[,prediccion]) 
    obs<-factor(paso[,c("obs")]) 
    tasa=1-tasafallos(pre,obs) 
    t<-as.data.frame(tasa) 
    t$modelo<-prediccion 
    medias0<-rbind(medias0,t) 
  } 
}


#ORDENACIÓN POR LA MEDIA 
medias0$modelo <- with(medias0, reorder(modelo,tasa, mean)) 
par(cex.axis=0.5,las=2) 
boxplot(data=medias0,tasa~modelo,main="TASA FALLOS")


tablamedias2<-medias0 %>%
  group_by(modelo) %>%
  summarize(tasa=mean(tasa))     


